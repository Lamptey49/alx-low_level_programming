Functions and nested loops here
